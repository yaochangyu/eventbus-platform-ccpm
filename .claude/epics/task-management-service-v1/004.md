---
name: Gherkin場景撰寫與測試案例設計
status: open
created: 2025-09-13T13:20:32Z
updated: 2025-09-13T13:20:32Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003]  # 需要BDD框架和領域模型
parallel: false  # 需要依賴領域模型設計
conflicts_with: []
---

# Task: Gherkin場景撰寫與測試案例設計

## Description

根據 PRD 的使用者故事，撰寫完整的 Gherkin 測試場景。這是 BDD 的核心步驟：**先定義行為規格，再實作功能**。所有後續的實作都必須以讓這些測試通過為目標。

## Acceptance Criteria
- [ ] 建立 TaskCreation.feature - 任務建立相關場景
- [ ] 建立 TaskDequeue.feature - 任務取出相關場景
- [ ] 建立 TaskExecution.feature - 任務執行和 Callback 場景
- [ ] 建立 TaskQuery.feature - 任務查詢相關場景
- [ ] 建立 TaskCancellation.feature - 任務取消相關場景
- [ ] 建立對應的步驟定義 (Step Definitions)
- [ ] 設計測試資料建構器
- [ ] 驗證所有場景可以解析但會失敗 (Red 狀態)

## Technical Details

### 核心 Feature 檔案

**TaskCreation.feature**
```gherkin
Feature: 任務建立
  作為開發者
  我想要透過API建立新任務
  為了啟動異步處理流程

  Scenario: 成功建立任務
    Given 我有有效的任務資訊
      | Name        | Description    | CallbackUrl                    |
      | TestTask    | 測試任務       | http://callback.test/webhook   |
    When 我發送POST請求到"/api/v1/tasks"
    Then 回應狀態碼應該是201
    And 回應應該包含任務ID
    And 任務狀態應該是"Queued"
    And 任務應該被加入到Queue

  Scenario: 建立任務時缺少必要欄位
    Given 我的任務資訊缺少CallbackUrl
    When 我發送POST請求到"/api/v1/tasks"
    Then 回應狀態碼應該是400
    And 錯誤訊息應該指出"CallbackUrl is required"
```

**TaskExecution.feature**
```gherkin
Feature: 任務執行
  作為系統
  我需要執行任務並呼叫Callback API
  為了完成異步處理流程

  Scenario: 成功執行任務並呼叫Callback
    Given 存在狀態為"Pending"的任務
      | Id                                   | CallbackUrl                  |
      | 550e8400-e29b-41d4-a716-446655440000 | http://callback.test/success |
    And Callback API回應200 OK
    When 我呼叫POST"/api/v1/tasks/550e8400-e29b-41d4-a716-446655440000/execute"
    Then 任務狀態應該更新為"Completed"
    And Callback API應該被呼叫一次
    And 任務應該被搬移到封存表

  Scenario: Callback API呼叫失敗
    Given 存在狀態為"Pending"的任務
    And Callback API回應500錯誤
    When 我執行任務
    Then 任務狀態應該更新為"Failed"
    And 錯誤資訊應該被記錄
```

### 步驟定義架構

```csharp
[Binding]
public class TaskManagementSteps : StepDefinitionBase
{
    [Given(@"我有有效的任務資訊")]
    public void GivenValidTaskData(Table table) { }

    [When(@"我發送POST請求到""(.*)""")]
    public async Task WhenISendPostRequest(string endpoint) { }

    [Then(@"回應狀態碼應該是(.*)")]
    public void ThenResponseStatusShouldBe(int expectedStatus) { }
}
```

### 測試資料建構

```csharp
public class TaskTestDataBuilder
{
    public static TaskCreateRequest ValidTaskRequest() => new()
    {
        Name = "TestTask",
        Description = "測試任務",
        CallbackUrl = "http://callback.test/webhook",
        Payload = new { Data = "test" }
    };
}
```

## Dependencies
- [ ] T002 - BDD測試框架設置完成
- [ ] T003 - 領域模型定義完成
- [ ] PRD 中的使用者故事和 API 規格

## Effort Estimate
- Size: L
- Hours: 12-16 小時
- Parallel: false (需要依賴前置任務)

## Definition of Done
- [ ] 所有5個核心功能都有完整的Gherkin場景
- [ ] 每個場景都有對應的步驟定義 (可以編譯但會失敗)
- [ ] 測試執行顯示所有場景為"紅燈"狀態 (尚未實作)
- [ ] 場景覆蓋所有成功路徑和失敗路徑
- [ ] Gherkin語法正確且可被SpecFlow解析
- [ ] 測試資料建構器可以產生所需的測試資料