---
name: 領域模型設計與實作
status: open
created: 2025-09-13T13:20:32Z
updated: 2025-09-13T13:20:32Z
github: [Will be updated when synced to GitHub]
depends_on: [001]  # 需要基礎專案結構
parallel: true  # 可與其他基礎任務並行
conflicts_with: []
---

# Task: 領域模型設計與實作

## Description

基於 BDD 場景需求，設計和實作核心領域模型。這些模型將成為整個系統的基礎，必須能夠支援所有 Gherkin 場景中定義的行為。

## Acceptance Criteria
- [ ] 實作 TaskItem 實體類別 (支援所有測試場景需求)
- [ ] 定義 TaskStatus 枚舉 (Queued, Pending, Processing, Completed, Failed, Cancelled)
- [ ] 實作 Result<T> Pattern 用於錯誤處理
- [ ] 建立 TaskCreateRequest, TaskResponse 等 DTO 模型
- [ ] 定義 ITaskRepository, IQueueService 等領域介面
- [ ] 實作領域事件 (TaskCreated, TaskStatusChanged 等)
- [ ] 建立模型驗證規則和業務邏輯
- [ ] 撰寫單元測試確保模型行為正確

## Technical Details

### 核心實體模型
```csharp
// Domain/Entities/TaskItem.cs
public class TaskItem
{
    public Guid Id { get; init; }
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string CallbackUrl { get; set; } = string.Empty;
    public TaskStatus Status { get; set; }
    public object? Payload { get; set; }
    public int Priority { get; set; }
    public DateTime CreatedAt { get; init; }
    public DateTime UpdatedAt { get; set; }
    public DateTime? ExecutedAt { get; set; }
    public object? CallbackResult { get; set; }

    // 業務邏輯方法
    public Result CanTransitionTo(TaskStatus newStatus) { }
    public void UpdateStatus(TaskStatus newStatus) { }
    public bool IsCompleted => Status is TaskStatus.Completed or TaskStatus.Failed or TaskStatus.Cancelled;
}

// Domain/Enums/TaskStatus.cs
public enum TaskStatus
{
    Queued = 0,     // 已加入佇列
    Pending = 1,    // 已從佇列取出，待執行
    Processing = 2, // 執行中
    Completed = 3,  // 執行完成
    Failed = 4,     // 執行失敗
    Cancelled = 5   // 已取消
}
```

### Result Pattern 實作
```csharp
// Domain/Common/Result.cs
public class Result
{
    public bool IsSuccess { get; }
    public string ErrorMessage { get; }

    protected Result(bool isSuccess, string errorMessage = "")
    {
        IsSuccess = isSuccess;
        ErrorMessage = errorMessage;
    }

    public static Result Success() => new(true);
    public static Result Failure(string error) => new(false, error);
}

public class Result<T> : Result
{
    public T? Value { get; }

    private Result(T value) : base(true) => Value = value;
    private Result(string error) : base(false, error) { }

    public static Result<T> Success(T value) => new(value);
    public static Result<T> Failure(string error) => new(error);
}
```

### DTO 模型
```csharp
// Models/TaskCreateRequest.cs
public record TaskCreateRequest
{
    [Required]
    [StringLength(100)]
    public string Name { get; init; } = string.Empty;

    [StringLength(500)]
    public string Description { get; init; } = string.Empty;

    [Required]
    [Url]
    public string CallbackUrl { get; init; } = string.Empty;

    public object? Payload { get; init; }

    [Range(0, 10)]
    public int Priority { get; init; } = 0;
}

// Models/TaskResponse.cs
public record TaskResponse
{
    public Guid TaskId { get; init; }
    public string Name { get; init; } = string.Empty;
    public TaskStatus Status { get; init; }
    public DateTime CreatedAt { get; init; }
    public DateTime UpdatedAt { get; init; }
    public string CallbackUrl { get; init; } = string.Empty;
}
```

### 領域介面
```csharp
// Domain/Interfaces/ITaskRepository.cs
public interface ITaskRepository
{
    Task<Result<TaskItem>> CreateAsync(TaskItem task);
    Task<Result<TaskItem?>> GetByIdAsync(Guid id);
    Task<Result> UpdateAsync(TaskItem task);
    Task<Result> DeleteAsync(Guid id);
    Task<Result<IEnumerable<TaskItem>>> GetByStatusAsync(TaskStatus status);
}

// Domain/Interfaces/IQueueService.cs
public interface IQueueService
{
    Task<Result> EnqueueAsync(Guid taskId);
    Task<Result<Guid?>> DequeueAsync();
    Task<Result> RemoveAsync(Guid taskId);
    Task<int> GetCountAsync();
}
```

### 領域事件
```csharp
// Domain/Events/TaskCreated.cs
public record TaskCreated(Guid TaskId, string Name, DateTime CreatedAt);

// Domain/Events/TaskStatusChanged.cs
public record TaskStatusChanged(Guid TaskId, TaskStatus OldStatus, TaskStatus NewStatus, DateTime ChangedAt);
```

## Dependencies
- [ ] T001 - 專案基礎結構建置完成
- [ ] 領域驅動設計 (DDD) 概念理解

## Effort Estimate
- Size: M
- Hours: 8-12 小時
- Parallel: true (可與測試框架設置並行)

## Definition of Done
- [ ] 所有領域模型類別實作完成並可編譯
- [ ] Result Pattern 實作完整且有單元測試
- [ ] DTO 模型包含完整的驗證屬性
- [ ] 領域介面定義清晰且符合 SOLID 原則
- [ ] TaskItem 的狀態轉換邏輯正確實作
- [ ] 單元測試覆蓋所有領域模型和業務邏輯
- [ ] 模型可以序列化/反序列化 JSON
- [ ] 符合 .NET 命名規範和最佳實踐